#!/usr/bin/env python3
"""
Complete viewport data processing workflow using shared pipeline.
Download embeddings ‚Üí Create RGB ‚Üí Create pyramids ‚Üí Create FAISS ‚Üí Compute UMAP

Usage:
    python3 setup_viewport.py --years 2022,2023,2024 --umap-year 2024
    python3 setup_viewport.py --years 2024                        (uses 2024 for UMAP)
"""

import sys
from pathlib import Path
import logging

# Add parent directory to path for lib imports
sys.path.insert(0, str(Path(__file__).parent))

from lib.pipeline import PipelineRunner
from lib.viewport_utils import get_active_viewport

logging.basicConfig(
    level=logging.INFO,
    format='%(message)s'
)
logger = logging.getLogger(__name__)


def main():
    import argparse

    parser = argparse.ArgumentParser(
        description='Complete viewport setup: download embeddings ‚Üí RGB ‚Üí pyramids ‚Üí FAISS ‚Üí UMAP'
    )
    parser.add_argument(
        '--years',
        type=str,
        required=True,
        help='Comma-separated years (e.g., 2022,2023,2024)'
    )
    parser.add_argument(
        '--umap-year',
        type=str,
        help='Year to compute UMAP from (default: last year in --years)'
    )

    args = parser.parse_args()

    # Parse years
    years = [y.strip() for y in args.years.split(',')]
    logger.info(f"\nüéØ Viewport Setup Workflow")
    logger.info(f"   Years to download: {', '.join(years)}")

    # Determine UMAP year
    umap_year = args.umap_year if args.umap_year else years[-1]
    logger.info(f"   UMAP year: {umap_year}")

    # Get active viewport
    try:
        viewport = get_active_viewport()
        viewport_name = viewport['viewport_id']
        logger.info(f"   Viewport: {viewport_name}")
    except Exception as e:
        logger.error(f"‚ùå Failed to read active viewport: {e}")
        return 1

    # Run pipeline
    project_root = Path(__file__).parent
    runner = PipelineRunner(project_root)

    success, error = runner.run_full_pipeline(
        viewport_name=viewport_name,
        years_str=args.years,
        compute_umap=True,
        umap_year=umap_year
    )

    if not success:
        logger.error(f"\n‚ùå Pipeline failed: {error}\n")
        return 1

    # Summary
    logger.info(f"\nüìä Results:")
    logger.info(f"   Viewport: {viewport_name}")
    logger.info(f"   Years downloaded: {args.years}")
    logger.info(f"   Pyramids: Created for web viewing")
    logger.info(f"   FAISS indexes: Created for each year")
    logger.info(f"   UMAP: Computed for {umap_year}")
    logger.info(f"\nüöÄ Next steps:")
    logger.info(f"   1. Run: bash restart.sh")
    logger.info(f"   2. Open: http://localhost:8001")
    logger.info(f"   3. Panel 4 will show UMAP visualization\n")

    return 0


if __name__ == "__main__":
    sys.exit(main())

