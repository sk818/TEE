# Viewport Setup Workflow

Complete pipeline: Download embeddings → Create FAISS indexes → Compute UMAP → View in Panel 4

## Quick Start

```bash
# Setup a viewport with embeddings for multiple years
./venv/bin/python3 setup_viewport.py --years 2022,2023,2024 --umap-year 2024

# Then start the services
bash restart.sh

# Open http://localhost:8001 and view UMAP in Panel 4
```

## Detailed Workflow

### Step 1: Download Embeddings

Downloads Tessera embeddings from remote server for selected years:

```bash
./venv/bin/python3 download_embeddings.py --years 2022,2023,2024
```

**Output:**
- `~/blore_data/mosaics/Eddington_embeddings_2022.tif`
- `~/blore_data/mosaics/Eddington_embeddings_2023.tif`
- `~/blore_data/mosaics/Eddington_embeddings_2024.tif`

### Step 2: Create FAISS Indexes

Creates FAISS indexes for each available year (reads active viewport):

```bash
./venv/bin/python3 create_faiss_index.py
```

**Output for each year:**
```
~/blore_data/faiss_indices/Eddington/2022/
  ├── embeddings.index       # FAISS index (fast search)
  ├── all_embeddings.npy     # All embeddings (264K × 128)
  ├── pixel_coords.npy       # Pixel coordinates (264K × 2)
  └── metadata.json          # Geotransform & metadata
```

### Step 3: Compute UMAP (2D Projection)

Reduces embeddings to 2D using UMAP for visualization:

```bash
./venv/bin/python3 compute_umap.py Eddington 2024
```

**Output:**
```
~/blore_data/faiss_indices/Eddington/2024/
  └── umap_coords.npy       # 2D coordinates (264K × 2)
```

### Step 4: Start Services & View

```bash
bash restart.sh
```

Open http://localhost:8001 and view:
- **Panel 4:** UMAP scatter plot (each point = 1 pixel, colored by embeddings)
- **Panel 5:** Distance heatmap (blue = similar, red = different between years)
- **Panel 6:** Second year embeddings for temporal comparison

## Unified Setup Script

Use `setup_viewport.py` to run all steps:

```bash
./venv/bin/python3 setup_viewport.py --years 2022,2023,2024 --umap-year 2024
```

This:
1. Downloads embeddings for 2022, 2023, 2024
2. Creates FAISS indexes for each year
3. Computes UMAP for 2024 (or specified year)
4. Reports success

## Individual Commands

Can also run steps separately:

```bash
# Download only specific years
./venv/bin/python3 download_embeddings.py --years 2024

# Create FAISS for all downloaded years
./venv/bin/python3 create_faiss_index.py

# Compute UMAP for different year
./venv/bin/python3 compute_umap.py Eddington 2023

# Start services
bash restart.sh
```

## Requirements

```bash
pip install umap-learn geotessera rasterio numpy faiss-cpu
```

## File Structure

```
blore/
├── setup_viewport.py          # Orchestrates full workflow
├── download_embeddings.py     # Step 1: Download
├── create_faiss_index.py      # Step 2: Create FAISS
├── compute_umap.py            # Step 3: Compute UMAP
├── backend/
│   └── web_server.py          # Step 4: Load UMAP in panel 4
└── restart.sh                 # Start web & tile servers

blore_data/
├── mosaics/
│   ├── Eddington_embeddings_2022.tif
│   ├── Eddington_embeddings_2023.tif
│   └── Eddington_embeddings_2024.tif
└── faiss_indices/
    └── Eddington/
        ├── 2022/
        ├── 2023/
        └── 2024/
            ├── embeddings.index
            ├── all_embeddings.npy
            ├── pixel_coords.npy
            ├── metadata.json
            └── umap_coords.npy       # Generated by compute_umap.py
```

## Troubleshooting

### UMAP not found error in Panel 4

**Error:** `UMAP coordinates not found`

**Fix:** Run `compute_umap.py` for the year being viewed:
```bash
./venv/bin/python3 compute_umap.py Eddington 2024
```

### UMAP computation slow

Single-threaded for stability (Numba threading conflicts). For 264K embeddings:
- ~1-2 minutes per viewport/year

### Memory issues

If system runs low on memory during FAISS creation, reduce `SAMPLING_FACTOR` in `create_faiss_index.py` or process one year at a time.
